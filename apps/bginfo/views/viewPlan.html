{{>header}}
<div role="main" class="main">
    <section class="page-top none-margin">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <ul class="breadcrumb">
                        <li class="active">{{#i18n}}bgi.bginfo{{/i18n}}</li>
                    </ul>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <h1 class="none-padding">{{#i18n}}bgi.planService{{/i18n}}</h1>
                </div>
            </div>
        </div>
    </section>
    <hr class="tall dashboard">
</div>
<div class="container">
    <div class="row">
        <div class="col-md-4">
            <div class="form-group">
                <label class="col-md-4 control-label" for="selectYear">{{#i18n}}bgi.budgetYear{{/i18n}}</label>
                <div class="col-md-8">
                    <select id="selectYear" name="selectYear" class="form-control input-sm" required="">
                        <option value="0">- เลือกปีงบประมาณ -</option>
                        <option value="2558">2558</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    <br>
    <div class="row">

        <div id="formHome" class="col-md-12">
            <div id="bidderTable" class="col-md-12"><!-- table shown bidder information list -->
                <table id="table" class="table table-bordered table-striped table-condensed mb-none">
                    <thead>
                        <tr>
                            <th class="text-center col-lg-1">ลำดับ</th>
                            <th class="text-center col-lg-8">แผนงาน</th>
                            <th class="text-center col-lg-3">สถานะ</th>
                        </tr>
                    </thead>
                    <tbody id="tdtable">
                        <tr>
                            <td colspan="3" class="text-center">กรุณาเลือกปีงบประมาณ</td>
                        </tr>
                    </tbody>
                </table>
            </div><!-- end table shown bidder information list -->
        </div>
        <div id="formBudget" class="col-md-12" style="display: none;">
        </div>
    </div><!--  row  -->
</div><!--  container  -->
{{>footer}}
<script type="text/javascript">
    $(document).ready(function () {
        $("#selectYear").change(function () {
            
            $.post("{{_context_path}}/api/bginfo/ProductionPlan/fetchPlan", {year: $(this).val()}, function (data) {
                $("#tdtable").html("");
                if(data.listsPlan.length!==0){
                    var ilast=0;
                    for (var i=0;i<data.listsPlan.length;i++) {
                        ilast++;
                        var html = "";
                        html += '<tr>';
                        html += '   <td class="text-center">'+(i+1)+'</td>';
                        html += '   <td>'+data.listsPlan[i].planName+'</td>';
                        html += '   <td class="text-center">';
                        html += '       <button ref-id="btnEdit" class="btn btn-warning"><i class="fa fa-pencil"></i> แก้ไข</button>';
                        html += '       <button ref-id="btnUpdate" row-id="'+data.listsPlan[i].id+'" class="btn btn-success" style="display:none;"><i class="fa fa-floppy-o"></i> แก้ไข</button>';
                        html += '   </td>';
                        html += '</tr>';
                        $("#tdtable").prepend(html);
                    }

                    var html = "";
                    html += '<tr>';
                    html += '   <td class="text-center">'+(ilast+1)+'</td>';
                    html += '   <td class="text-center">';
                    html += '       <div class="form-group">';
                    html += '           <input type="text" class="form-control" ref-id="txtPlanAdd" placeholder="ชื่อแผนงาน">';
                    html += '       </div>';
                    html += '   </td>';
                    html += '   <td class="text-center">';
                    html += '       <button ref-id="btnSave" class="btn btn-success"><i class="fa fa-plus"></i> เพิ่ม</button>';
                    html += '   </td>';
                    html += '</tr>';
                    $("#tdtable").prepend(html);
                }else{
                    $("#tdtable").html('<tr><td colspan="3" class="text-center">ไม่พบข้อมูล</td></tr>');
                }
            });

        });
        
        $(document).on("click","[ref-id=btnSave]",function(){
            
            var saveToData = {data:{planName:$("[ref-id=txtPlanAdd]").val(),budgetYear:$("#selectYear").val(),isActive:1}};
            $.post("{{_context_path}}/api/bginfo/ProductionPlan/savePlan",JSON.stringify(saveToData), function (req) {
                
                //alert(JSON.stringify(req, null, 4));
                
                if(req.reqSavePlan!=="exist"){
                    var html = "";
                    html += '<tr>';
                    html += '   <td class="text-center">'+$("#tdtable").find("tr").length+'</td>';
                    html += '   <td>'+$("[ref-id=txtPlanAdd]").val()+'</td>';
                    html += '   <td class="text-center">';
                    html += '       <button ref-id="btnEdit" class="btn btn-warning"><i class="fa fa-pencil"></i> แก้ไข</button>';
                    html += '       <button ref-id="btnUpdate" row-id="'+req.reqSavePlan.id+'" class="btn btn-success" style="display:none;"><i class="fa fa-floppy-o"></i> แก้ไข</button>';
                    html += '   </td>';
                    html += '</tr>';
                    $("#tdtable").find("tr").eq(0).after(html);
                    $("[ref-id=txtPlanAdd]").val("");
                    $("#tdtable").find("tr").eq(0).find("td").eq(0).text($("#tdtable").find("tr").length);
                        
                }else{
                    $("[ref-id=txtPlanAdd]").parent(".form-group").addClass("has-error");
                }
            
            });
            
        });
        
        $(document).on("click","[ref-id=btnEdit]",function(){
            
                var html = "";
                html += '<div class="form-group">';
                html += '   <input type="text" class="form-control" value="'+$(this).parents("tr").find("td").eq(1).html()+'" ref-id="txtPlanEdit" placeholder="แก้ไขชื่อแผนงาน">';
                html += '</div>';
                $(this).parents("tr").find("td").eq(1).html(html);
                $(this).parents("tr").find("[ref-id=btnEdit]").hide();
                $(this).parents("tr").find("[ref-id=btnUpdate]").show();
            
            
        });
        
        $(document).on("click","[ref-id=btnUpdate]",function(){
            var saveToData = {data:{id:$(this).attr("row-id"),planName:$(this).parents("tr").find("[ref-id=txtPlanEdit]").val()}};
            $.post("{{_context_path}}/api/bginfo/ProductionPlan/savePlan",JSON.stringify(saveToData), function () {
                $(this).parents("tr").find("td").eq(1).html($(this).parents("tr").find("[ref-id=txtPlanEdit]").val());
                $(this).parents("tr").find("[ref-id=btnUpdate]").hide();
                $(this).parents("tr").find("[ref-id=btnEdit]").show();
            });
            
        });


    });
</script>