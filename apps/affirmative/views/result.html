{{>header}}
<div role="main" class="main">
    <section class="page-top none-margin">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <ul class="breadcrumb">
                        <li class="active">ตัวชี้วัดคำรับรองการปฏิบัติงาน</li>
                    </ul>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <h1 class="none-padding">รายงานผลการดำเนินงาน</h1>
                </div>
            </div>
        </div>
    </section>

    <hr class="tall dashboard">

    <div class="sort-source-wrapper"><!-- button action on header -->
        <div class="container">
            <ul class="nav nav-pills sort-source menu-top pull-right" data-sort-id="portfolio" data-option-key="filter">
                <li class="active">
                    <button class="btn btn-default back" style="display: none;"><i class="fa fa-angle-double-left"> ย้อนกลับ</i></button>
                </li>
            </ul>
        </div>
    </div><!-- end button action on header -->

    <div class="container">
        <div class="row">

            <div id="deptList">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th class="text-center col-md-2">ประเภทส่วนงาน</th>
                            <th class="text-center col-md-5">คณะ / หน่วยงาน</th>
                            <th class="text-center col-md-3">สถานะ</th>
                            <th class="text-center col-md-2">เครื่องมือ</th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
            <div id="panelHome" class="col-md-12" style="display: none;">
                <div class="row">
                    <div class="form-group">
                        <label class="col-md-3 control-label text-right" for="affKpiId">รอบ : </label>
                        <div class="col-md-6">
                            <select type="text" class="form-control input-sm" name="affKpiId" id="affKpiId"></select>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="tabs">
                            <ul id="tabMenu" class="nav nav-tabs">

                            </ul>
                            <div id="tabContent" class="tab-content">

                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div><!--  row  -->
    </div><!--  container  -->
</div><!-- main -->

{{>footer}}

<script type="text/javascript">
    var findNode = {};
    var listArr = {};

    $(function () {
        listsDepartment();

        $("button.back").unbind("click").click(function () {
            toggleShow("home");
        })
    });

    function listsDepartment(){
        var datas = callAjax("{{_context_path}}/api/affirmative/result/listsDepartment", "post", {}, "json");
        if (typeof datas !== "undefined" && datas !== null) {
            var html = '';
            $.each(datas["lists"], function(key, val){
                $.each(val["dept"], function(key2, val2){
                    html += '<tr>'
                            + '<td>'+val["actName"]+'</td>'
                            + '<td>'+val2["deptName"]+'</td>'
                            + '<td>-</td>'
                            + '<td>'
                                + '<button class="btn btn-primary tracking" data-id="'+val["deptId"]+'"><i class="fa fa-pencil"></i> รายงานผล</button>'
                            + '</td>'
                        + '</tr>';
                });
            });

            $("#deptList table tbody").html(html);

            $("button.tracking").unbind().click(function(){
                toggleShow("form");

                centerForm();
            });
        }
    }

    function centerForm() {
        var contentArr = {};

        var datas = callAjax("{{_context_path}}/api/affirmative/center/listsAll2", "post", {}, "json");
        if (typeof datas !== "undefined" && datas !== null) {
            var menu = '<li class="active">'
                    + '<a href="#taball" data-toggle="tab"><i class="fa fa-star"></i> ทั้งหมด</a>'
                + '</li>';

            var content = '<div id="taball" class="tab-pane active">'
                    + '<table id="tableall" class="table table-hover table-bordered">'
                        + '<thead>'
                            + '<tr>'
                                + '<th rowspan="3" class="col-md-3 text-center" style="vertical-align: middle;">ประเด็นยุทธศาสตร์/เป้าประสงค์/ตัวชี้วัด</th>'
                                + '<th rowspan="3" class="col-md-1 text-center" style="vertical-align: middle;">หน่วยนับ</th>'
                                + '<th rowspan="3" class="text-center" style="vertical-align: middle;">ค่าเป้าหมายตัวชี้วัด</th>'
                                + '<th rowspan="3" class="text-center col-md-1" style="vertical-align: middle;">ระดับคะแนน</th>'
                                + '<th rowspan="3" class="text-center" style="vertical-align: middle;">รายละเอียดผลการดำเนินงาน<br>ตามตัวชี้วัด</th>'
                                + '<th colspan="4" class="col-md-3 text-center" style="vertical-align: middle;">คำนวนผลการดำเนินงานตามตัวชี้วัด</th>'
                                + '<th rowspan="3" class="text-center" style="vertical-align: middle;">หมายเหตุ</th>'
                                + '<th rowspan="3" class="text-center" style="vertical-align: middle;">ไฟล์แนบ</th>'
                            + '</tr>'
                            + '<tr>'
                                + '<th style="vertical-align: middle;">ตัวตั้ง</th>'
                                + '<th rowspan="2" style="vertical-align: middle;">ผลลัพธ์<br>ตัวชี้วัด</th>'
                                + '<th rowspan="2" style="vertical-align: middle;">ระดับ<br>คะแนน</th>'
                                + '<th style="text-align: left; vertical-align: middle;" rowspan="2">✔ = บรรลุ<br>✘ = ไม่บรรลุ</th>'
                            + '</tr>'
                            + '<tr>'
                                + '<th style="vertical-align: middle;">ตัวหาร</th>'
                            + '</tr>'
                        + '</thead>'
                        + '<tbody>'
                            + '<tr>'
                                + '<td colspan="11" class="text-center">-</td>'
                            + '</tr>'
                        + '</tbody>'
                    + '</table>'
                + '</div>';

            $.each(datas["lists"], function (key1, value1) {
                menu += '<li>'
                        + '<a href="#tab' + value1["mainId"] + '" data-toggle="tab">ส่วนที่ ' + value1["mainSeq"] + ' ' + value1["mainName"] + '</a>'
                        + '</li>';

                content += '<div id="tab' + value1["mainId"] + '" class="tab-pane">'
                        + '<table id="table' + value1["mainId"] + '" class="table table-hover table-bordered">'
                            + '<thead>'
                                + '<tr>'
                                    + '<th rowspan="3" class="col-md-3 text-center" style="vertical-align: middle;">ประเด็นยุทธศาสตร์/เป้าประสงค์/ตัวชี้วัด</th>'
                                    + '<th rowspan="3" class="col-md-1 text-center" style="vertical-align: middle;">หน่วยนับ</th>'
                                    + '<th rowspan="3" class="text-center" style="vertical-align: middle;">ค่าเป้าหมายตัวชี้วัด</th>'
                                    + '<th rowspan="3" class="text-center col-md-1" style="vertical-align: middle;">ระดับคะแนน</th>'
                                    + '<th rowspan="3" class="text-center" style="vertical-align: middle;">รายละเอียดผลการดำเนินงาน<br>ตามตัวชี้วัด</th>'
                                    + '<th colspan="4" class="col-md-3 text-center" style="vertical-align: middle;">คำนวนผลการดำเนินงานตามตัวชี้วัด</th>'
                                    + '<th rowspan="3" class="text-center" style="vertical-align: middle;">หมายเหตุ</th>'
                                    + '<th rowspan="3" class="text-center" style="vertical-align: middle;">ไฟล์แนบ</th>'
                                + '</tr>'
                                + '<tr>'
                                    + '<th style="vertical-align: middle;">ตัวตั้ง</th>'
                                    + '<th rowspan="2" style="vertical-align: middle;">ผลลัพธ์<br>ตัวชี้วัด</th>'
                                    + '<th rowspan="2" style="vertical-align: middle;">ระดับ<br>คะแนน</th>'
                                    + '<th style="text-align: left; vertical-align: middle;" rowspan="2">✔ = บรรลุ<br>✘ = ไม่บรรลุ</th>'
                                + '</tr>'
                                + '<tr>'
                                    + '<th style="vertical-align: middle;">ตัวหาร</th>'
                                + '</tr>'
                            + '</thead>'
                            + '<tbody>'
                                + '<tr>'
                                    + '<td colspan="11" class="text-center">-</td>'
                                + '</tr>'
                            + '</tbody>'
                        + '</table>'
                    + '</div>';
//
                contentArr[value1["mainId"]] += '<tr data-tt-id="main' + value1["mainId"] + '">' +
                        '<td colspan="5">' +
                        '<span class="text-bold" style="text-decoration: underline;">' +
                        'ส่วนที่ ' + value1["mainSeq"] + '</span> ' + value1["mainName"] +
                        '</td>' +
                        '</tr>';
                $.each(value1["type"], function (key2, value2) {
                    contentArr[value1["mainId"]] += '<tr data-tt-id="type' + value2["typeId"] + '" data-tt-parent-id="main' + value1["mainId"] + '">' +
                            '<td colspan="5">' +
                            '<span class="text-bold" style="text-decoration: underline;">' +
                            'ส่วนที่ ' + value1["mainSeq"] + '.' + value2['typeSeq'] +
                            '</span> ' + value2["typeName"] +
                            '</td>' +
                            '</tr>';
                    if (value2["hasIssue"] == "Y") {
                        $.each(value2["issue"], function (key3, value3) {
                            contentArr[value1["mainId"]] += '<tr data-tt-id="issue' + value3["issueId"] + '" data-tt-parent-id="type' + value2["typeId"] + '">' +
                                    '<td colspan="5"><span class="text-bold" style="text-decoration: underline;">' +
                                    'ประเด็นยุทธศาสตร์ที่ ' + value3['issueSeq'] + '</span> ' + value3["issueName"] + '</td>' +
                                    '</tr>';
//
                            $.each(value3["target"], function (key4, value4) {
                                contentArr[value1["mainId"]] += '<tr data-tt-id="target' + value4["targetId"] + '" data-tt-parent-id="issue' + value3["issueId"] + '">'
                                        + '<td colspan="4"><span class="text-bold" style="text-decoration: underline;">เป้าประสงค์ที่ ' + value3["issueSeq"] + '.' + value4["targetSeq"] + '</span> ' + value4["targetName"] + '</td>'
                                        + '<td class="text-center">'
                                        + '<button class="btn btn-sm btn-success add" data-pid="' + value4["targetId"] + '">'
                                        + '<i class="fa fa-plus"></i> เพิ่ม</button></td>'
                                        + '</tr>';
                                if (typeof value4["kpi"] !== "undefined" && value4["kpi"] !== null) {
                                    $.each(value4["kpi"], function (key5, value5) {
                                        var group = [];
                                        $.each(value5["centerGroup"], function (keyGroup, valueGroup) {
                                            group.push("-" + valueGroup["groupName"]);
                                        });
                                        contentArr[value1["mainId"]] += '<tr data-tt-id="center' + value5["centerId"] + '" data-tt-parent-id="target' + value4["targetId"] + '">'
                                                + '<td style="padding-left: 20px;">' + value3["issueSeq"] + '.' + value4["targetSeq"] + '.' + value5["kpiSeq"] + ' ' + value5["kpiName"] + '</td>'
                                                + '<td class="center">' + value5["unit"]["unitName"] + '</td>'
                                                + '<td>' + group.join('<br>') + '</td>'
                                                + '<td class="text-center">' + (value5["remark"] ? value5["remark"] : "-") + '</td>'
                                                + '<td class="text-center">'
                                                + '<div class="btn-group">'
                                                + '<button type="button" class="btn btn-sm btn-warning edit" data-pid="' + value4["targetId"] + '" data-id="' + value5["centerId"] + '"><i class="fa fa-pencil"></i> แก้ไข</button>'
                                                + '<button type="button" class="btn btn-sm btn-default delete" data-pid="' + value4["targetId"] + '" data-id="' + value5["centerId"] + '"><i class="fa fa-trash"></i> ลบ</button>'
                                                + '</div>'
                                                + '</td>'
                                                + '</tr>';

                                    });
                                }
//

                            });
                        });
                    } else if (value2["hasIssue"] == "N") {
                        if (typeof value2["kpi"] !== "undefined" && value2["kpi"] !== null) {
                            $.each(value2["kpi"], function (key5, value5) {
                                var group = [];
                                $.each(value5["centerGroup"], function (keyGroup, valueGroup) {
                                    group.push(" - " + valueGroup["groupName"]);
                                });
                                contentArr[value1["mainId"]] += '<tr data-tt-id="center' + value5["centerId"] + '" data-tt-parent-id="type' + value2["typeId"] + '">'
                                        + '<td style="padding-left: 20px;">' + value5["kpiSeq"] + '.' + value5["kpiName"] + '</td>'
                                        + '<td class="center">' + value5["unit"]["unitName"] + '</td>'
                                        + '<td>' + group.join('<br>') + '</td>'
                                        + '<td class="text-center">' + (value5["remark"] ? value5["remark"] : "-") + '</td>'
                                        + '<td class="text-center">'
                                        + '<div class="btn-group">'
                                        + '<button type="button" class="btn btn-sm btn-warning edit" data-pid="' + value2["typeId"] + '" data-id="' + value5["centerId"] + '"><i class="fa fa-pencil"></i> แก้ไข</button>'
                                        + '<button type="button" class="btn btn-sm btn-default delete" data-pid="' + value2["typeId"] + '" data-id="' + value5["centerId"] + '"><i class="fa fa-trash"></i> ลบ</button>'
                                        + '</div>'
                                        + '</td>'
                                        + '</tr>';

                            });
                        }
                    }
//

                });
                $("#tabMenu").html(menu);
                $("#tabContent").html(content);
                var contentAll = '';
                $.each(contentArr, function (key, value) {
                    contentAll += value
                    $("#table" + key + " tbody").html(value);

                    $("#table" + key).treetable({
                        expandable: true,
                        initialState: "expanded"
                    });
                });

                $("#tableall tbody").html(contentAll);
                $("#tableall").treetable({
                    expandable: true,
                    initialState: "expanded"
                });

                $("button.add").unbind().click(function () {
                    var targetId = $(this).attr("data-pid");

                    // reset form for new insert
                    $("#loadingForm").html('');
                    $("#form").trigger('reset');
                    $("#panelForm").modal("show");
                    listsKpi(targetId);
                    listsUnit();
                    $("button.save").click(function () {
                        autoKpiName();
                        var isValid = true;
                        $('#form input[required]').each(function () {
                            if ($(this).val() == "" && !$(this).prop("disabled"))
                                isValid = false;
                        });
                        if (isValid) {
                            var fdata = dataObject(targetId, null);
                            console.log(fdata);
                            //centerInsert(targetId, fdata);
                        }
                    });

                });
//
                centerAction();
            });
        }
    }

    function toggleShow(option){
        if(option == "home"){
            $("#panelHome").hide();
            $("#deptList").show();
        }
        else if(option == "form"){
            $("#deptList").hide();
            $("#panelHome").show();
        }
    }
</script>