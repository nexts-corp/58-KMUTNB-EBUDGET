{{>header}}
<div role="main" class="main">
    <section class="page-top none-margin">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <ul class="breadcrumb">
                        <li class="active">ตัวชี้วัดคำรับรองการปฏิบัติงาน</li>
                    </ul>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <h1 class="none-padding">{{#department}}{{departmentName}}{{/department}}</h1>
                </div>
            </div>
        </div>
    </section>

    <hr class="tall dashboard">

    <div class="sort-source-wrapper"><!-- button action on header -->
        <div class="container">
            <ul class="nav nav-pills sort-source menu-top pull-right" data-sort-id="portfolio" data-option-key="filter">
                <li class="active">
                    <button class="btn btn-primary" id="btnApprove" style="display: none;"><i class="fa fa-send"> ส่งแบบตัวชี้วัด</i></button>
                </li>
            </ul>
        </div>
    </div><!-- end button action on header -->

    <div class="container">

        <div class="row">

            <div id="panelHome" class="col-md-12">
                <div class="row">
                    <div class="col-md-12">
                        <div class="tabs">
                            <ul id="tabMenu" class="nav nav-tabs">

                            </ul>
                            <div id="tabContent" class="tab-content">

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="panelForm" aria-labelledby="bidderLabel" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form id="form" onsubmit="return false;">

                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                <h4 class="modal-title" id="myModalLabel">ตัวชี้วัดคำรับรองการปฏิบัติงาน</h4>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="strategyId">ตัวชี้วัด</label>
                                    <div class="col-md-8">
                                        <select class="form-control input-sm" name="strategyId" id="strategyId" data-lock="Y"></select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="strategySeq">ลำดับที่</label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control input-sm" name="strategySeq" id="strategySeq" data-lock="Y" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="strategyName">ตัวชี้วัดคำรับรอง</label>
                                    <div class="col-md-8">
                                        <textarea class="form-control input-sm" name="strategyName" id="strategyName" required></textarea>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="unitId">หน่วยนับ</label>
                                    <div class="col-md-8">
                                        <select  class="form-control input-sm" name="unitId" id="unitId" data-lock="Y" required></select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="strategyGoal">ค่าเป้าหมายตัวชี้วัด</label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control input-sm" name="strategyGoal" id="strategyGoal" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="score1">คะแนน1</label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control input-sm" name="score1" id="score1" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="score2">คะแนน2</label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control input-sm" name="score2" id="score2" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="score3">คะแนน3</label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control input-sm" name="score3" id="score3" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="score4">คะแนน4</label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control input-sm" name="score4" id="score4" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="score5">คะแนน5</label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control input-sm" name="score5" id="score5" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="remark">หมายเหตุ</label>
                                    <div class="col-md-8">
                                        <textarea class="form-control input-sm" name="remark" id="remark"></textarea>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="isActive">สถานะ</label>
                                    <div class="col-md-8">
                                        <select class="form-control input-sm" name="isActive" id="isActive">
                                            <option value="Y">ใช้งาน</option>
                                            <option value="N">ไม่ใช้งาน</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="loadingForm" class="col-md-12 text-center"></div>
                                <div class="modal-footer">
                                    <ul class="nav nav-pills sort-source pull-right" data-option-key="filter">
                                        <li data-option-value="*" class="">
                                            <button class="btn btn-success save"><i class="fa fa-save"></i> บันทึก</button>
                                        </li>
                                        <li data-option-value="" class="padding-left">
                                            <button type="button" class="btn btn-default" data-dismiss="modal">ยกเลิก</button>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="panelDeleteForm" aria-labelledby="bidderLabel" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title">ลบตัวชี้วัดคำรับรองการปฏิบัติงาน</h4>
                        </div>
                        <div class="modal-body">
                            <table>
                                <tbody>
                                    <tr>
                                        <td class="col-md-4 text-right text-bold" style="vertical-align: top;">ลำดับที่ : </td>
                                        <td class="col-md-8" id="strategySeqDel"></td>
                                    </tr>
                                    <tr>
                                        <td class="col-md-4 text-right text-bold" style="vertical-align: top;">ตัวชี้วัดคำรับรอง : </td>
                                        <td class="col-md-8" id="strategyNameDel"></td>
                                    </tr>
                                    <tr>
                                        <td class="col-md-4 text-right text-bold" style="vertical-align: top;">หน่วยนับ : </td>
                                        <td class="col-md-8" id="unitNameDel"></td>
                                    </tr>
                                    <tr>
                                        <td class="col-md-4 text-right text-bold" style="vertical-align: top;">ค่าเป้าหมายตัวชี้วัด : </td>
                                        <td class="col-md-8" id="strategyGoalDel"></td>
                                    </tr>
                                    <tr>
                                        <td class="col-md-4 text-right text-bold" style="vertical-align: top;">หมายเหตุ : </td>
                                        <td class="col-md-8" id="remarkDel"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="modal-footer">
                            <ul class="nav nav-pills sort-source pull-right" data-option-key="filter">
                                <li data-option-value="*" class="">
                                    <button class="btn btn-danger save"><i class="fa fa-trash"></i> ยืนยันการลบ</button>
                                </li>
                                <li data-option-value="" class="padding-left">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">ยกเลิก</button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div><!--  row  -->
    </div><!--  container  -->
</div><!-- main -->

{{>footer}}

<script type="text/javascript">
    var findNode = {};
    var listArr = {};
    var unit = {};
    var deptId = '{{#department}}{{departmentId}}{{/department}}';
    var typeId = '{{typeId}}';
    $(function () {
        centerForm();
        $("#btnApprove").click(function () {
            var result = callAjax("{{_context_path}}/api/actionplan/draft/approve", "post", {departmentId: deptId, status: "Y"}, "json");
            if (result["approve"] == true) {
                alert("อนุมัติสำเร็จ!");
                window.location = "{{_context_path}}/api/actionplan/view/draftAll";
            } else {
                alert("อนุมัติไม่สำเร็จ! (" + result["msg"] + ")");
            }
        });
    });
    function centerForm() {
        var contentArr = {};

        var datas = callAjax("{{_context_path}}/api/actionplan/draft/listsAll", "post", {departmentId: deptId, typeId: typeId}, "json");
        //  console.log(datas);
        if (typeof datas["lists"] !== "undefined" && datas["lists"] !== null && datas["lists"] !== false) {
            $("#btnApprove").show();
            var menu = '<li class="active">'
                    + '<a href="#taball" data-toggle="tab"><i class="fa fa-star"></i> ทั้งหมด</a>'
                    + '</li>';
            var content = '<div id="taball" class="tab-pane active">'
                    + '<table id="tableall" class="table table-hover table-bordered">'
                    + '<thead>'
                    + '<tr>'
                    + '<th class="text-center col-md-1" style="vertical-align: middle;" rowspan="2">ลำดับ</th>'
                    + '<th class="text-center col-md-4" style="vertical-align: middle;" rowspan="2">ตัวชี้วัดคำรับรอง ปี {{year}}</th>'
                    + '<th class="text-center col-md-1" style="vertical-align: middle;" rowspan="2">หน่วยนับ</th>'
                    + '<th class="text-center col-md-1" style="vertical-align: middle;" rowspan="2">ค่าเป้าหมายตัวชี้วัด</th>'
                    + '<th class="text-center col-md-3" style="vertical-align: middle;" colspan="5">เกณฑ์การให้คะแนนผลลัพธ์ของตัวชี้วัด (ระดับคะแนน)</th>'
                    + '<th class="text-center col-md-1" style="vertical-align: middle;" rowspan="2">หมายเหตุ</th>'
                    + '<th class="text-center col-md-1" style="vertical-align: middle;" rowspan="2">จัดการ</th>'
                    + '</tr>'
                    + '<tr>'
                    + '<th class="text-center" style="vertical-align: middle;">คะแนน 1</th>'
                    + '<th class="text-center" style="vertical-align: middle;">คะแนน 2</th>'
                    + '<th class="text-center" style="vertical-align: middle;">คะแนน 3</th>'
                    + '<th class="text-center" style="vertical-align: middle;">คะแนน 4</th>'
                    + '<th class="text-center" style="vertical-align: middle;">คะแนน 5</th>'
                    + '</tr>'
                    + '</thead>'
                    + '<tbody>'
                    + '<tr>'
                    + '<td colspan="11" class="text-center">-</td>'
                    + '</tr>'
                    + '</tbody>'
                    + '</table>'
                    + '</div>';

            $.each(datas["lists"], function (key1, value1) {
                $.each(value1.issue, function (key2, value2) {s

                    contentArr[value2["issueSeq"]] += '<tr data-tt-id="type' + value2["typeId"] + '" data-tt-parent-id="main' + value1["mainSeq"] + '" data-seq="' + value2["typeSeq"] + '">'
                            + '<td class="text-center"></td>'
                            + '<td colspan="10">'
                            + '<span class="text-bold" style="text-decoration: underline;">ส่วนที่ ' + value1["mainSeq"] + '.' + value2['typeSeq'] + ' ' + value2["typeName"] + (value2["title"] != "" ? "<h3>" + value2["title"] + "</h3>" : "") + '</span>'
                            + '</td>'
                            + '</tr>';

                    $.each(value2["issue"], function (key3, value3) {
                        contentArr[value2["issueSeq"]] += '<tr data-tt-id="issue' + value3["issueId"] + '" data-tt-parent-id="type' + value2["typeId"] + '" data-seq="' + value3["issueSeq"] + '">'
                                + '<td class="text-center"></td>'
                                + '<td colspan="10">'
                                + '<span class="text-bold">ประเด็นยุทธศาสตร์ที่ ' + value3['issueSeq'] + ' ' + value3["issueName"] + '</span>'
                                + '</td>'
                                + '</tr>';

                        $.each(value3["target"], function (key4, value4) {
                            contentArr[value2["issueSeq"]] += '<tr data-tt-id="target' + value4["targetId"] + '" data-tt-parent-id="issue' + value3["issueId"] + '" data-seq="' + value4["targetSeq"] + '" >'
                                    + '<td class="text-center"></td>'
                                    + '<td colspan="9">'
                                    + '<span class="text-bold">เป้าประสงค์ที่ ' + value3["issueSeq"] + '.' + value4["targetSeq"] + ' ' + value4["targetName"] + '</span>'
                                    + '</td>'
                                    + '<td class="text-center">'
                                    + '<button class="btn btn-sm btn-success add" data-pid="' + value4["targetId"] + '" data-pname="targetId"><i class="fa fa-plus-circle"></i> เพิ่ม</button>'
                                    + '</td>'
                                    + '</tr>';

                            if (typeof value4["strategy"] !== "undefined" && value4["strategy"] !== null) {
                                $.each(value4["strategy"], function (key5, value5) {

                                    contentArr[value2["issueSeq"]] += '<tr data-tt-id="draft' + value5["draftId"] + '" data-tt-parent-id="target' + value4["targetId"] + '"  data-seq="' + value5["strategySeq"] + '">'
                                            + '<td class="text-center"></td>'
                                            + (value5["isActive"] == "Y" ? '<td>' : '<td class="text-primary">') + value3["issueSeq"] + '.' + value4["targetSeq"] + '.' + value5["strategySeq"] + ' ' + text2html(value5["strategyName"]) + '</td>'
                                            + (value5["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + value5["unitName"] + '</td>'
                                            + (value5["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (value5["strategyGoal"] ? value5["strategyGoal"] : "") + '</td>'
                                            + (value5["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (value5["score1"] ? value5["score1"] : "") + '</td>'
                                            + (value5["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (value5["score2"] ? value5["score2"] : "") + '</td>'
                                            + (value5["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (value5["score3"] ? value5["score3"] : "") + '</td>'
                                            + (value5["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (value5["score4"] ? value5["score4"] : "") + '</td>'
                                            + (value5["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (value5["score5"] ? value5["score5"] : "") + '</td>'
                                            + '<td class="text-center">' + (value5["remark"] ? value5["remark"] : "") + '</td>'
                                            + '<td class="text-center">'
                                            + '<div class="btn-group">'
                                            + (value5["isApprove"] == "N" ?
                                                    (
                                                            value5["isCenter"] == "Y" ?
                                                            '<button type="button" class="btn btn-sm btn-warning edit" data-edit="N" data-pid="' + value4["targetId"] + '" data-id = "' + value5["draftId"] + '" > <i class="fa fa-pencil"></i>แก้ไข</button>'
                                                            :
                                                            '<button type="button" class="btn btn-sm btn-warning edit" data-edit="Y" data-pid="' + value4["targetId"] + '" data-id="' + value5["draftId"] + '"><i class="fa fa-pencil"></i> แก้ไข</button>'
                                                            ) : ""
                                                    )
                                            + (value5["isApprove"] == "N" ?
                                                    (
                                                            value5["isCenter"] == "Y" ?
                                                            ""
                                                            :
                                                            '<button type="button" class="btn btn-sm btn-default delete" data-pid="' + value4["targetId"] + '" data-id="' + value5["draftId"] + '"><i class="fa fa-trash"></i> ลบ</button>'
                                                            ) : ""
                                                    )
                                            + '</div>'
                                            + '</td>'
                                            + '</tr>';

                                    listArr[value5["draftId"]] = value5;
                                });
                            }
                        });
                    });
                });
                //   });
                $("#tabMenu").html(menu);
                $("#tabContent").html(content);
                var contentAll = '';
                $.each(contentArr, function (key, value) {
                    contentAll += value
                    $("#table" + key + " tbody").html(value);
                    $("#table" + key).treetable({
                        expandable: true,
                        initialState: "expanded"
                    });
                });
                $("#tableall tbody").html(contentAll);
                $("#tableall").treetable({
                    expandable: true,
                    initialState: "expanded"
                });
                $("button.add").unbind().click(function () {
                    var pId = $(this).attr("data-pid");
                    var pName = $(this).attr("data-pname");
                    // reset form for new insert
                    $("#loadingForm").html('');
                    $("#form").trigger('reset');
                    $("#form [data-lock=Y]").each(function () {
                        $(this).attr("disabled", false);
                    });
                    $("#panelForm").modal("show");
                    listsKpi(pId);
                    $("button.save").unbind().click(function () {
                        var isValid = true;
                        $('#form input[required]').each(function () {
                            if ($(this).val() == "")
                                isValid = false;
                        });
                        if (isValid) {
                            var fdata = dataObject(pId, pName, null);
                            //console.log(fdata);
                            centerInsert(fdata);

                        } else {
                            alert("กรุณากรอกข้อมูลให้ครบ");
                        }
                    });
                });
//
                centerAction();
            });
        } else {

            $("#panelHome").html("<div class='text-center text-default col-sm-12'>ตัวชี้วัดคำรับรองการปฏิบัติงาน อนุมัติเรียบร้อยแล้ว</div>");
        }
    }

    function centerAction() {
        $("button.edit").unbind().click(function () {
            var pId = $(this).attr("data-pid");
            var draftId = $(this).attr("data-id");
            var edit = $(this).attr("data-edit");
            // reset form for new insert
            $("#loadingForm").html('');
            $("#form").trigger('reset');
            $("#panelForm").modal("show");
            listsKpi(pId);
            //   console.log(listArr[draftId]);
            $("#form input[type=text], #form textarea, #form select").each(function () {
                var fid = $(this).attr("id");
                var lock = $(this).attr("data-lock");
                $("#" + fid).val(listArr[draftId][fid]);
                if (edit == "N" && lock == "Y") {
                    $("#" + fid).attr("disabled", true);
                } else {
                    $("#" + fid).attr("disabled", false);
                }
            });
            $("button.save").unbind("click").click(function () {
                var isValid = true;
                var status = $("#isActive").val();
                if (status == "Y") {
                    $('#form input[required]').each(function () {
                        if ($(this).val() == "" && !$(this).prop("disabled"))
                            isValid = false;
                    });
                }
                if (isValid) {
                    var fdata = dataObject(draftId, "draftId", null);
                    //console.log(fdata);
                    centerEdit(fdata);
                }
            });
        });
        $("button.delete").unbind("click").click(function () {
            var draftId = $(this).attr("data-id");
            $("#panelDeleteForm").modal("show");
            $("#panelDeleteForm").find('td').each(function () {
                if ($(this).attr("id")) {
                    var aId = $(this).attr("id");
                    var name = aId.replace('Del', '');
                    $("#" + aId).html(getTag(listArr[draftId][name], "-"));
                }
            });
            $("button.save").unbind("click").click(function () {

                centerDelete(draftId);
            });
        });
    }

    function centerInsert(fdata) {
        $("#loadingForm").html("Loading...");
        setTimeout(function () {
            var dataJSON = JSON.stringify({draft: fdata});
            var dataJSONEN = encodeURIComponent(dataJSON);
            var datas = callAjax("{{_context_path}}/api/actionplan/draft/insert", "post", dataJSONEN, "json");
            var data = datas["insert"];

            if (typeof data !== "undefined" && data !== null) {
                if (data != false) {
                    $("#loadingForm").html('<span class="text-success">บันทึกข้อมูลเรียบร้อย</span>');
                    listArr[data["draftId"]] = data;
                    var mainSeq = data["mainSeq"];
                    var input = "";
                    var node, node2;
                    if (data["targetId"] == 0) {
                        input = '<tr data-tt-id="draft' + data["draftId"] + '" data-tt-parent-id="type' + data["typeId"] + '"  data-seq="' + data["strategySeq"] + '" >'
                                + '<td class="text-center"></td>'
                                + (data["isActive"] == "Y" ? '<td>' : '<td class="text-primary">') + data["strategySeq"] + '.' + data["strategyName"] + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + data["unitName"] + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["strategyGoal"] ? data["strategyGoal"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score1"] ? data["score1"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score2"] ? data["score2"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score3"] ? data["score3"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score4"] ? data["score4"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score5"] ? data["score5"] : "") + '</td>'
                                + '<td class="text-center">' + (data["remark"] ? data["remark"] : "") + '</td>'
                                + '<td class="text-center">'
                                + '<div class="btn-group">'
                                + (
                                        data["isCenter"] == "Y" ?
                                        '<button type="button" class="btn btn-sm btn-warning edit" data-edit="N" data-pid="' + data["typeId"] + '" data-id = "' + data["draftId"] + '" > <i class="fa fa-pencil"></i>แก้ไข</button>'
                                        :
                                        '<button type="button" class="btn btn-sm btn-warning edit" data-edit="Y" data-pid="' + data["typeId"] + '" data-id="' + data["draftId"] + '"><i class="fa fa-pencil"></i> แก้ไข</button>'
                                        )
                                + (data["isCenter"] == "Y" ? "" : '<button type="button" class="btn btn-sm btn-default delete" data-pid="' + data["typeId"] + '" data-id="' + data["draftId"] + '"><i class="fa fa-trash"></i> ลบ</button>')
                                + '</div>'
                                + '</td>'
                                + '</tr>';
                        node = $("#tableall").treetable("node", "type" + data["typeId"]);
                        node2 = $("#table" + mainSeq).treetable("node", "type" + data["typeId"]);
                    } else {
                        input = '<tr data-tt-id="draft' + data["draftId"] + '" data-tt-parent-id="target' + data["targetId"] + '"  data-seq="' + data["strategySeq"] + '">'
                                + '<td class="text-center"></td>'
                                + (data["isActive"] == "Y" ? '<td style="padding-left: 20px;">' : '<td style="padding-left: 20px;" class="text-primary">') + data["issueSeq"] + '.' + data["targetSeq"] + '.' + data["strategySeq"] + ' ' + data["strategyName"] + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + data["unitName"] + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["strategyGoal"] ? data["strategyGoal"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score1"] ? data["score1"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score2"] ? data["score2"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score3"] ? data["score3"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score4"] ? data["score4"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score5"] ? data["score5"] : "") + '</td>'
                                + '<td class="text-center">' + (data["remark"] ? data["remark"] : "") + '</td>'
                                + '<td class="text-center">'
                                + '<div class="btn-group">'
                                + (
                                        data["isCenter"] == "Y" ?
                                        '<button type="button" class="btn btn-sm btn-warning edit" data-edit="N" data-pid="' + data["targetId"] + '" data-id = "' + data["draftId"] + '" > <i class="fa fa-pencil"></i>แก้ไข</button>'
                                        :
                                        '<button type="button" class="btn btn-sm btn-warning edit" data-edit="Y" data-pid="' + data["targetId"] + '" data-id="' + data["draftId"] + '"><i class="fa fa-pencil"></i> แก้ไข</button>'
                                        )
                                + (data["isCenter"] == "Y" ? "" : '<button type="button" class="btn btn-sm btn-default delete" data-pid="' + data["targetId"] + '" data-id="' + data["draftId"] + '"><i class="fa fa-trash"></i> ลบ</button>')
                                + '</div>'
                                + '</td>'
                                + '</tr>';
                        node = $("#tableall").treetable("node", "target" + data["targetId"]);
                        node2 = $("#table" + mainSeq).treetable("node", "target" + data["targetId"]);
                    }
                    $("#tableall").treetable("loadBranch", node, input);
                    $("#table" + mainSeq).treetable("loadBranch", node2, input);
                    $("#tableall").treetable("sortBranch", node);
                    $("#table" + mainSeq).treetable("sortBranch", node2);
                    $("#panelForm").modal("hide");
                    centerAction();
                }
                else {
                    $("#loadingForm").html('<span class="text-danger">ไม่สามารถบันทึกข้อมูลได้</span>');
                }
            }
        }, 500);
    }

    function centerEdit(fdata) {
        $("#loadingForm").html("Loading...");

        setTimeout(function () {
            var dataJSON = JSON.stringify({draft: fdata});
            var dataJSONEN = encodeURIComponent(dataJSON);
            var datas = callAjax("{{_context_path}}/api/actionplan/draft/update", "post", dataJSONEN, "json");
            var data = datas["update"];
            if (typeof data !== "undefined" && data !== null) {
                if (data != false) {
                    $("#loadingForm").html('<span class="text-success">บันทึกข้อมูลเรียบร้อย</span>');
                    listArr[data["draftId"]] = data;
                    // var mainSeq = $("tr[data-tt-id=type" + data["typeId"] + "]").attr("data-tt-parent-id").substr(4);
                    var mainSeq = data["mainSeq"];
                    var input = "";
                    var node, node2;
                    if (data["targetId"] == 0) {
                        input = '<tr data-tt-id="draft' + data["draftId"] + '" data-tt-parent-id="type' + data["typeId"] + '"  data-seq="' + data["strategySeq"] + '" >'
                                + (data["isActive"] == "Y" ? '<td style="padding-left: 20px;">' : '<td style="padding-left: 20px;" class="text-primary">') + data["strategySeq"] + '.' + data["strategyName"] + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + data["unitName"] + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["strategyGoal"] ? data["strategyGoal"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score1"] ? data["score1"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score2"] ? data["score2"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score3"] ? data["score3"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score4"] ? data["score4"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score5"] ? data["score5"] : "") + '</td>'
                                //   + '<td>' + group.join('<br>') + '</td>'
                                + '<td class="text-center">' + (data["remark"] ? data["remark"] : "") + '</td>'
                                + '<td class="text-center">'
                                + '<div class="btn-group">'
                                + (
                                        data["isCenter"] == "Y" ?
                                        '<button type="button" class="btn btn-sm btn-warning edit" data-edit="N" data-pid="' + data["typeId"] + '" data-id = "' + data["draftId"] + '" > <i class="fa fa-pencil"></i>แก้ไข</button>'
                                        :
                                        '<button type="button" class="btn btn-sm btn-warning edit" data-edit="Y" data-pid="' + data["typeId"] + '" data-id="' + data["draftId"] + '"><i class="fa fa-pencil"></i> แก้ไข</button>'
                                        )
                                + (data["isCenter"] == "Y" ? "" : '<button type="button" class="btn btn-sm btn-default delete" data-pid="' + data["typeId"] + '" data-id="' + data["draftId"] + '"><i class="fa fa-trash"></i> ลบ</button>')
                                + '</div>'
                                + '</td>'
                                + '</tr>';
                        node = $("#tableall").treetable("node", "type" + data["typeId"]);
                        node2 = $("#table" + mainSeq).treetable("node", "type" + data["typeId"]);
                    } else {
                        input = '<tr data-tt-id="draft' + data["draftId"] + '" data-tt-parent-id="target' + data["targetId"] + '"  data-seq="' + data["strategySeq"] + '">'
                                + (data["isActive"] == "Y" ? '<td style="padding-left: 20px;">' : '<td style="padding-left: 20px;" class="text-primary">') + data["issueSeq"] + '.' + data["targetSeq"] + '.' + data["strategySeq"] + ' ' + data["strategyName"] + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + data["unitName"] + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["strategyGoal"] ? data["strategyGoal"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score1"] ? data["score1"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score2"] ? data["score2"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score3"] ? data["score3"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score4"] ? data["score4"] : "") + '</td>'
                                + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + (data["score5"] ? data["score5"] : "") + '</td>'
                                + '<td class="text-center">' + (data["remark"] ? data["remark"] : "") + '</td>'
                                + '<td class="text-center">'
                                + '<div class="btn-group">'
                                + (
                                        data["isCenter"] == "Y" ?
                                        '<button type="button" class="btn btn-sm btn-warning edit" data-edit="N" data-pid="' + data["targetId"] + '" data-id = "' + data["draftId"] + '" > <i class="fa fa-pencil"></i>แก้ไข</button>'
                                        :
                                        '<button type="button" class="btn btn-sm btn-warning edit" data-edit="Y" data-pid="' + data["targetId"] + '" data-id="' + data["draftId"] + '"><i class="fa fa-pencil"></i> แก้ไข</button>'
                                        )
                                + (data["isCenter"] == "Y" ? "" : '<button type="button" class="btn btn-sm btn-default delete" data-pid="' + data["targetId"] + '" data-id="' + data["draftId"] + '"><i class="fa fa-trash"></i> ลบ</button>')
                                + '</div>'
                                + '</td>'
                                + '</tr>';
                        node = $("#tableall").treetable("node", "target" + data["targetId"]);
                        node2 = $("#table" + mainSeq).treetable("node", "target" + data["targetId"]);
                    }

                    $("#tableall").treetable("removeNode", "draft" + data["draftId"]);
                    $("#table" + mainSeq).treetable("removeNode", "draft" + data["draftId"]);
                    $("#tableall").treetable("loadBranch", node, input);
                    $("#table" + mainSeq).treetable("loadBranch", node2, input);
                    $("#tableall").treetable("sortBranch", node);
                    $("#table" + mainSeq).treetable("sortBranch", node2);

                    $("#panelForm").modal("hide");
                    centerAction();
                }
                else {
                    $("#loadingForm").html('<span class="text-danger">ไม่สามารถบันทึกข้อมูลได้</span>');
                }
            }
        }, 500);
    }

    function centerDelete(draftId) {
        var dataJSON = JSON.stringify({draft: {draftId: draftId}});
        var dataJSONEN = encodeURIComponent(dataJSON);
        var datas = callAjax("{{_context_path}}/api/actionplan/draft/delete", "post", dataJSONEN, "json");
        if (typeof datas !== "undefined" && datas !== null) {
            if (datas["delete"] == true) {
                $("#tableall").treetable("removeNode", "draft" + draftId);

                var mainSeq = listArr[draftId]["mainSeq"];
                $("#table" + mainSeq).treetable("removeNode", "draft" + draftId);

                $("#panelDeleteForm").modal("hide");
            }
        }
    }

    function listsKpi(targetId) {
        var datas = callAjax("{{_context_path}}/api/actionplan/center/listsKpi", "post", {targetId: targetId}, "json");
        if (typeof datas !== "undefined" && datas !== null) {
            var html = '<option value="0">เลือกตัวชี้วัด</option>';
            $.each(datas["lists"], function (key, value) {
                html += '<option value="' + value["strategyId"] + '">' + value["strategyName"] + '</option>'
            });
            $("#strategyId").html(html);
            autoKpiName();
            listsUnit();
        }
    }
    function autoKpiName() {
        $("#strategyId").change(function () {
            if (this.value != 0) {
                var text = $("#strategyId option:selected").text();
                $("#strategyName").val(text);
            } else {
                $("#strategyName").val("");
            }
        });
    }
    function listsUnit() {
        var datas = callAjax("{{_context_path}}/api/actionplan/center/listsUnit", "post", {}, "json");
        if (typeof datas["lists"] !== "undefined" && datas["lists"] !== null) {
            //unit = datas["lists"];
            var html;
            $.each(datas["lists"], function (key, value) {
                html += '<option value="' + value["unitId"] + '">' + value["unitName"] + '</option>';
                unit[value["unitId"]] = value;
            });
            $("#unitId").html(html);
            $("#unitId").change(function () {
                var unitId = this.value;
                $.each(unit[unitId], function (k, v) {
                    $("#" + k).val(v);
                });
            });
        }
    }

    function dataObject(parentId, pName, id) {
        var fParam = {};
        if (id != null || id == 0) {
            fParam["strategyId"] = id;
        }
        fParam[pName] = parentId;
        if (pName == "typeId") {
            fParam["targetId"] = "0";
            fParam["departmentId"] = deptId;
        } else if (pName == "targetId") {
            fParam["typeId"] = "0";
            fParam["departmentId"] = deptId;
        }
        $("#form select, #form input[type=text], #form textarea").each(function () {
            var name = $(this).attr("name");
            var val = $(this).val();
            fParam[name] = val;
        });

        var fdata = {};
        fdata = fParam;
        return fdata;
    }
</script>