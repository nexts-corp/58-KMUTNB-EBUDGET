{{>header}}
<div role="main" class="main">
    <section class="page-top none-margin">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <ul class="breadcrumb">
                        <li class="active">ตัวชี้วัดคำรับรองการปฏิบัติงาน</li>
                    </ul>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <h1 class="none-padding">{{#department}}{{departmentName}}{{/department}}</h1>
                </div>
            </div>
        </div>
    </section>

    <hr class="tall dashboard">

    <div class="sort-source-wrapper"><!-- button action on header -->
        <div class="container">
            <ul class="nav nav-pills sort-source menu-top pull-right" data-sort-id="portfolio" data-option-key="filter">
                <li class="active">
                    <button class="btn btn-primary" id="btnRefresh"><i class="fa fa-refresh"> เรียงลำดับใหม่</i></button>
                </li>
                <li>
                    <button class="btn btn-primary" id="btnApprove" style="display: none;"><i class="fa fa-send"> ส่งแบบตัวชี้วัด</i></button>
                </li>
            </ul>
        </div>
    </div><!-- end button action on header -->

    <div class="container">

        <div class="row">

            <div id="panelHome" class="col-md-12">
                <div class="row">
                    <div class="col-md-12">
                        <div class="tabs">
                            <ul id="tabMenu" class="nav nav-tabs">

                            </ul>
                            <div id="tabContent" class="tab-content">

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="dialogDraft" aria-labelledby="bidderLabel" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form id="formDraft" onsubmit="return false;">

                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                <h4 class="modal-title" id="myModalLabel">โครงการ/กิจกรรม</h4>
                            </div>
                            <div class="modal-body">

                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="projectSeq">ลำดับที่</label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control input-sm" name="projectSeq" id="projectSeq" data-lock="Y" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="projectName">โครงการ/กิจกรรม/ตัวชี้วัด</label>
                                    <div class="col-md-8">
                                        <textarea class="form-control input-sm" name="projectName" id="projectName" required></textarea>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="timeDuration">ระยะเวลาดำเนินการ</label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control input-sm" name="timeDuration" id="timeDuration" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="budget">งบประมาณแผ่นดิน</label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control input-sm" name="budget" id="budget" >
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="revenue">งบประมาณเงินรายได้</label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control input-sm" name="revenue" id="revenue" >
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="other">งบประมาณแหล่งอื่น</label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control input-sm" name="other" id="other" >
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="noBudget">ไม่ใช้งบประมาณ</label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control input-sm" name="noBudget" id="noBudget">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="remark">หมายเหตุ</label>
                                    <div class="col-md-8">
                                        <textarea class="form-control input-sm" name="remark" id="remark"></textarea>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="isActive">สถานะ</label>
                                    <div class="col-md-8">
                                        <select class="form-control input-sm" name="isActive" id="isActive">
                                            <option value="Y">ใช้งาน</option>
                                            <option value="N">ไม่ใช้งาน</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="loadingForm" class="col-md-12 text-center"></div>
                                <div class="modal-footer">
                                    <ul class="nav nav-pills sort-source pull-right" data-option-key="filter">
                                        <li data-option-value="*" class="">
                                            <button class="btn btn-success saveDraft"><i class="fa fa-save"></i> บันทึก</button>
                                        </li>
                                        <li data-option-value="" class="padding-left">
                                            <button type="button" class="btn btn-default" data-dismiss="modal">ยกเลิก</button>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="dialogDetail" aria-labelledby="bidderLabel" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form id="formDetail" onsubmit="return false;">

                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                <h4 class="modal-title">รายละเอียดโครงการ/กิจกรรม <span id='titleDetail'></span></h4>
                            </div>
                            <div class="modal-body">

                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="detailSeq">ลำดับที่</label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control input-sm" name="detailSeq" id="detailSeq" data-lock="Y" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="detailName">โครงการ/กิจกรรม/ตัวชี้วัด</label>
                                    <div class="col-md-8">
                                        <textarea class="form-control input-sm" name="detailName" id="detailName" required></textarea>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="unit">ค่าเป้าหมายตามตัวชี้วัด</label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control input-sm" name="unit" id="unit" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="remark">หมายเหตุ</label>
                                    <div class="col-md-8">
                                        <textarea class="form-control input-sm" name="remark" id="remark"></textarea>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="isActive">สถานะ</label>
                                    <div class="col-md-8">
                                        <select class="form-control input-sm" name="isActive" id="isActive">
                                            <option value="Y">ใช้งาน</option>
                                            <option value="N">ไม่ใช้งาน</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="loadingForm" class="col-md-12 text-center"></div>
                                <div class="modal-footer">
                                    <ul class="nav nav-pills sort-source pull-right" data-option-key="filter">
                                        <li data-option-value="*" class="">
                                            <button class="btn btn-success saveDetail"><i class="fa fa-save"></i> บันทึก</button>
                                        </li>
                                        <li data-option-value="" class="padding-left">
                                            <button type="button" class="btn btn-default" data-dismiss="modal">ยกเลิก</button>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="dialogDeleteDraft" aria-labelledby="bidderLabel" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form id="deleteDraft" onsubmit="return false;">

                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                <h4 class="modal-title" id="myModalLabel">โครงการ/กิจกรรม</h4>
                            </div>
                            <div class="modal-body">

                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="projectSeq">ลำดับที่ : </label>
                                    <label class="col-md-8 control-label frmDel" id="projectSeq"></label>
                                    <!--                                    <div class="col-md-8">
                                                                            <input type="text" class="form-control input-sm" name="projectSeq" id="projectSeq" data-lock="Y" required>
                                                                        </div>-->
                                </div>

                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="projectName">โครงการ/กิจกรรม : </label>
                                    <label class="col-md-8 control-label frmDel" id="projectName"></label>
                                    <!--                                    <div class="col-md-8">
                                                                            <textarea class="form-control input-sm" name="projectName" id="projectName" required></textarea>
                                                                        </div>-->
                                </div>

                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="timeDuration">ระยะเวลาดำเนินการ : </label>
                                    <label class="col-md-8 control-label frmDel" id="timeDuration"></label>
                                    <!--                                    <div class="col-md-8">
                                                                            <input type="text" class="form-control input-sm" name="timeDuration" id="timeDuration" required>
                                                                        </div>-->
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="budget">งบประมาณแผ่นดิน : </label>
                                    <label class="col-md-8 control-label frmDel" id="budget"></label>
                                    <!--                                    <div class="col-md-8">
                                                                            <input type="text" class="form-control input-sm" name="budget" id="budget" >
                                                                        </div>-->
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="revenue">งบประมาณเงินรายได้ : </label>
                                    <label class="col-md-8 control-label frmDel" id="revenue"></label>
                                    <!--                                    <div class="col-md-8">
                                                                            <input type="text" class="form-control input-sm" name="revenue" id="revenue" >
                                                                        </div>-->
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="other">งบประมาณแหล่งอื่น : </label>
                                    <label class="col-md-8 control-label frmDel" id="other"></label>
                                    <!--                                    <div class="col-md-8">
                                                                            <input type="text" class="form-control input-sm" name="other" id="other" >
                                                                        </div>-->
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="noBudget">ไม่ใช้งบประมาณ : </label>
                                    <label class="col-md-8 control-label frmDel" id="noBudget"></label>
                                    <!--                                    <div class="col-md-8">
                                                                            <input type="text" class="form-control input-sm" name="noBudget" id="noBudget">
                                                                        </div>-->
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="remark">หมายเหตุ : </label>
                                    <label class="col-md-8 control-label frmDel" id="remark"></label>
                                    <!--                                    <div class="col-md-8">
                                                                            <textarea class="form-control input-sm" name="remark" id="remark"></textarea>
                                                                        </div>-->
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="isActive">สถานะ : </label>
                                    <label class="col-md-8 control-label frmDel" id="isActive"></label>
                                    <!--                                    <div class="col-md-8">
                                                                            <select class="form-control input-sm" name="isActive" id="isActive">
                                                                                <option value="Y">ใช้งาน</option>
                                                                                <option value="N">ไม่ใช้งาน</option>
                                                                            </select>
                                                                        </div>-->
                                </div>
                                <div id="loadingForm" class="col-md-12 text-center"></div>
                                <div class="modal-footer">
                                    <ul class="nav nav-pills sort-source pull-right" data-option-key="filter">
                                        <li data-option-value="*" class="">
                                            <button class="btn btn-danger delDraft"><i class="fa fa-trash"></i> ลบ</button>
                                        </li>
                                        <li data-option-value="" class="padding-left">
                                            <button type="button" class="btn btn-default" data-dismiss="modal">ยกเลิก</button>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div id="dialogDeleteDetail" aria-labelledby="bidderLabel" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form id="deleteDetail" onsubmit="return false;">

                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                <h4 class="modal-title" id="myModalLabel">โครงการ/กิจกรรม</h4>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="detailSeq">ลำดับที่</label>
                                    <label class="col-md-8 control-label frmDel" id="detailSeq">สถานะ</label>
                                    <!--                                    <div class="col-md-8">
                                                                            <input type="text" class="form-control input-sm" name="detailSeq" id="detailSeq" data-lock="Y" required>
                                                                        </div>-->
                                </div>

                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="detailName">โครงการ/กิจกรรม/ตัวชี้วัด</label>
                                    <label class="col-md-8 control-label frmDel" id="detailName">สถานะ</label>
                                    <!--                                    <div class="col-md-8">
                                                                            <textarea class="form-control input-sm" name="detailName" id="detailName" required></textarea>
                                                                        </div>-->
                                </div>

                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right req" for="unit">ค่าเป้าหมายตามตัวชี้วัด</label>
                                    <label class="col-md-8 control-label frmDel" id="unit">สถานะ</label>
                                    <!--                                    <div class="col-md-8">
                                                                            <input type="text" class="form-control input-sm" name="unit" id="unit" required>
                                                                        </div>-->
                                </div>

                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="remark">หมายเหตุ</label>
                                    <label class="col-md-8 control-label frmDel" id="remark">สถานะ</label>
                                    <!--                                    <div class="col-md-8">
                                                                            <textarea class="form-control input-sm" name="remark" id="remark"></textarea>
                                                                        </div>-->
                                </div>
                                <div class="form-group">
                                    <label class="col-md-4 control-label text-right" for="isActive">สถานะ</label>
                                    <label class="col-md-8 control-label frmDel" id="isActive">สถานะ</label>
                                </div>

                                <div id="loadingForm" class="col-md-12 text-center"></div>
                                <div class="modal-footer">
                                    <ul class="nav nav-pills sort-source pull-right" data-option-key="filter">
                                        <li data-option-value="*" class="">
                                            <button class="btn btn-danger delDetail"><i class="fa fa-trash"></i> ลบ</button>
                                        </li>
                                        <li data-option-value="" class="padding-left">
                                            <button type="button" class="btn btn-default" data-dismiss="modal">ยกเลิก</button>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div><!--  row  -->
    </div><!--  container  -->
</div><!-- main -->

{{>footer}}

<script type="text/javascript">
    var findNode = {};
    var listDraft = {};
    var listDetail = {};
    var listArr = {"Draft": {}, "Detail": {}};
    var unit = {};
    var deptId = '{{#department}}{{departmentId}}{{/department}}';
    var typeId = '{{typeId}}';
    var periodCode = '{{year}}';
    $(function () {
        centerForm();
        $("#btnRefresh").click(function () {
            centerForm();
        });
        $("#btnApprove").click(function () {
            var result = callAjax("{{_context_path}}/api/actionplan/draft/approve", "post", {departmentId: deptId, status: "Y"}, "json");
            if (result["approve"] == true) {
                alert("อนุมัติสำเร็จ!");
                window.location = "{{_context_path}}/api/actionplan/view/draftAll";
            } else {
                alert("อนุมัติไม่สำเร็จ! (" + result["msg"] + ")");
            }
        });
    });
    function centerForm() {
        var contentArr = {};
        var datas = callAjax("{{_context_path}}/api/actionplan/draft/listsAll", "post", {departmentId: deptId, typeId: typeId}, "json");
        //  console.log(datas);
        if (typeof datas["lists"] !== "undefined" && datas["lists"] !== null && datas["lists"] !== false) {
            $("#btnApprove").show();
            var menu = '<li class="active">'
                    + '<a href="#taball" data-toggle="tab"><i class="fa fa-star"></i> ทั้งหมด</a>'
                    + '</li>';
            var content = '<div id="taball" class="tab-pane active">'
                    + '<table id="tableall" class="table table-hover table-bordered">'
                    + '<thead>'
                    + '<tr>'
                    + '<th class="text-center" style="vertical-align: middle;" rowspan="3">ลำดับ</th>'
                    + '<th class="text-center col-md-3" style="vertical-align: middle;" rowspan="3">ประเด็นยุทธศาสตร์/เป้าประสงค์/กลยุทธ์/โครงการ/กิจกรรม/ตัวชี้วัด</th>'
                    + '<th class="text-center col-md-1" style="vertical-align: middle;" rowspan="3">ค่าเป้าหมายตามตัวชี้วัด โครงการ/กิจกรรม</th>'
                    + '<th class="text-center col-md-1" style="vertical-align: middle;" rowspan="3">ระยะเวลาดำเนินการ</th>'
                    + '<th class="text-center col-md-4" style="vertical-align: middle;" colspan="4">แหล่งเงินงบประมาณ (บาท)</th>'
                    + '<th class="text-center col-md-2" style="vertical-align: middle;" rowspan="3">เครื่องมือ</th>'
                    + '</tr>'
                    + '<tr>'
                    + '<th class="text-center" style="vertical-align: middle;" colspan="2">มหาวิทยาลัยจัดสรร</th>'
                    + '<th class="text-center" style="vertical-align: middle;" rowspan="2">งบประมาณแหล่งอื่น</th>'
                    + '<th class="text-center" style="vertical-align: middle;" rowspan="2">ไม่ใช้งบประมาณ</th>'
                    + '</tr>'
                    + '<tr>'
                    + '<th class="text-center" style="vertical-align: middle;">งปม.แผ่นดิน</th>'
                    + '<th class="text-center" style="vertical-align: middle;">งปม.เงินรายได้</th>'
                    + '</tr>'
                    + '</thead>'
                    + '<tbody>'
                    + '<tr>'
                    + '<td colspan="9" class="text-center">-</td>'
                    + '</tr>'
                    + '</tbody>'
                    + '</table>'
                    + '</div>';

            $.each(datas["lists"], function (key1, value1) {
                $.each(value1["issue"], function (key2, value2) {
                    menu += '<li>'
                            + '<a href="#tab' + value2["issueSeq"] + '" data-toggle="tab">ประเด็นที่ ' + value2["issueSeq"] + ' ' + value2["issueName"] + '</a>'
                            + '</li>';

                    content += '<div id="tab' + value2["issueSeq"] + '" class="tab-pane">'
                            + '<table id="table' + value2["issueSeq"] + '" class="table table-hover table-bordered">'
                            + '<thead>'
                            + '<tr>'
                            + '<th class="text-center" style="vertical-align: middle;" rowspan="3">ลำดับ</th>'
                            + '<th class="text-center col-md-3" style="vertical-align: middle;" rowspan="3">ประเด็นยุทธศาสตร์/เป้าประสงค์/กลยุทธ์/โครงการ/กิจกรรม/ตัวชี้วัด</th>'
                            + '<th class="text-center col-md-1" style="vertical-align: middle;" rowspan="3">ค่าเป้าหมายตามตัวชี้วัด โครงการ/กิจกรรม</th>'
                            + '<th class="text-center col-md-1" style="vertical-align: middle;" rowspan="3">ระยะเวลาดำเนินการ</th>'
                            + '<th class="text-center col-md-4" style="vertical-align: middle;" colspan="4">แหล่งเงินงบประมาณ (บาท)</th>'
                            + '<th class="text-center col-md-2" style="vertical-align: middle;" rowspan="3">เครื่องมือ</th>'
                            + '</tr>'
                            + '<tr>'
                            + '<th class="text-center" style="vertical-align: middle;" colspan="2">มหาวิทยาลัยจัดสรร</th>'
                            + '<th class="text-center" style="vertical-align: middle;" rowspan="2">งบประมาณแหล่งอื่น</th>'
                            + '<th class="text-center" style="vertical-align: middle;" rowspan="2">ไม่ใช้งบประมาณ</th>'
                            + '</tr>'
                            + '<tr>'
                            + '<th class="text-center" style="vertical-align: middle;">งปม.แผ่นดิน</th>'
                            + '<th class="text-center" style="vertical-align: middle;">งปม.เงินรายได้</th>'
                            + '</tr>'
                            + '</thead>'
                            + '<tbody>'
                            + '<tr>'
                            + '<td colspan="9" class="text-center">-</td>'
                            + '</tr>'
                            + '</tbody>'
                            + '</table>'
                            + '</div>';

                    contentArr[value2["issueSeq"]] += '<tr data-tt-id="issue' + value2["issueId"] + '" data-seq="' + value2["issueSeq"] + '">'
                            + '<td class="text-center"></td>'
                            + '<td colspan="8">'
                            + '<span class="text-bold" style="text-decoration: underline;">ประเด็นยุทธศาสตร์ที่ ' + value2['issueSeq'] + ' ' + value2["issueName"] + '</span>'
                            + '</td>'
                            + '</tr>';
                    $.each(value2["target"], function (key3, value3) {
                        contentArr[value2["issueSeq"]] += '<tr data-tt-id="target' + value3["targetId"] + '" data-tt-parent-id="issue' + value2["issueId"] + '" data-seq="' + value3["targetSeq"] + '" >'
                                + '<td class="text-center"></td>'
                                + '<td colspan="8">'
                                + '<span class="text-bold">เป้าประสงค์ที่ ' + value2["issueSeq"] + '.' + value3["targetSeq"] + ' ' + value3["targetName"] + '</span>'
                                + '</td>'
                                + '</tr>';
                        $.each(value3["strategy"], function (key4, value4) {
                            contentArr[value2["issueSeq"]] += '<tr data-tt-id="strategy' + value4["strategyId"] + '" data-tt-parent-id="target' + value3["targetId"] + '" data-seq="' + value4["strategySeq"] + '" >'
                                    + '<td class="text-center"></td>'
                                    + '<td colspan="7">'
                                    + '<span class="text-bold">กลยุทธ์ที่ ' + value3["targetSeq"] + '.' + value4["strategySeq"] + ' ' + value4["strategyName"] + '</span>'
                                    + '</td>'
                                    + '<td class="text-center">'
                                    + '<button class="btn btn-sm btn-success add" data-id="' + value4["strategyId"] + '" data-name="strategyId"><i class="fa fa-plus-circle"></i> เพิ่ม</button>'
                                    + '</td>'
                                    + '</tr>';
                            if (typeof value4["draft"] !== "undefined" && value4["draft"] !== null) {
                                $.each(value4["draft"], function (key5, value5) {
                                    contentArr[value2["issueSeq"]] += '<tr data-tt-id="draft' + value5["draftId"] + '" data-tt-parent-id="strategy' + value4["strategyId"] + '" data-seq="' + value5["projectSeq"] + '" >'
                                            + '<td class="text-center"></td>'
                                            + '<td>'
                                            + '<span class="text-bold">' + value5["projectSeq"] + ". " + value5["projectName"] + '</span>'
                                            + '</td>'
                                            + '<td></td>'
                                            + '<td class="text-center">' + (value5["timeDuration"] ? value5["timeDuration"] : "") + '</td>'
                                            + '<td class="text-center">' + (value5["budget"] ? value5["budget"] : "") + '</td>'
                                            + '<td class="text-center">' + (value5["revenue"] ? value5["revenue"] : "") + '</td>'
                                            + '<td class="text-center">' + (value5["other"] ? value5["other"] : "") + '</td>'
                                            + '<td class="text-center">' + (value5["noBudget"] ? value5["noBudget"] : "") + '</td>'
                                            + '<td class="text-center">'
                                            + '<button class="btn btn-sm btn-success add" data-id="' + value5["draftId"] + '" data-name="draftId" data-pid="' + value4["strategyId"] + '" data-pname="strategyId" ><i class="fa fa-plus-circle"></i> เพิ่ม</button>'
                                            + '<button type="button" class="btn btn-sm btn-warning edit" data-edit="Y" data-id="' + value5["draftId"] + '" data-name="draftId"><i class="fa fa-pencil"></i> แก้ไข</button>'
                                            + '<button type="button" class="btn btn-sm btn-default delete" data-id="' + value5["draftId"] + '" data-name="draftId" data-pid="' + value4["strategyId"] + '" data-pname="strategyId" ><i class="fa fa-trash"></i> ลบ</button>'
                                            + '</td>'
                                            + '</tr>';
                                    listArr["Draft"][value5["draftId"]] = value5;
                                    listArr["Draft"][value5["draftId"]]["issueSeq"] = value2["issueSeq"];
                                    listArr["Draft"][value5["draftId"]]["Detail"] = {};
                                    if (typeof value5["detail"] !== "undefined" && value5["detail"] !== null) {
                                        $.each(value5["detail"], function (key6, value6) {
                                            contentArr[value2["issueSeq"]] += '<tr data-tt-id="detail' + value6["detailId"] + '" data-tt-parent-id="draft' + value5["draftId"] + '"  data-seq="' + value6["detailSeq"] + '">'
                                                    + '<td class="text-center"></td>'
                                                    + (value5["isActive"] == "Y" ? '<td>' : '<td class="text-primary">') + '- ' + text2html(value6["detailName"]) + '</td>'
                                                    + (value5["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + value6["unit"] + '</td>'
                                                    + '<td class="text-center"></td>'
                                                    + '<td class="text-center"></td>'
                                                    + '<td class="text-center"></td>'
                                                    + '<td class="text-center"></td>'
                                                    + '<td class="text-center"></td>'
                                                    + '<td>'
                                                    + '<div class="btn-group">'
                                                    + //(value6["isApprove"] == "N" ?
                                                    '<button type="button" class="btn btn-sm btn-warning edit" data-edit="Y" data-pid="' + value5["draftId"] + '" data-pname="draftId" data-id="' + value6["detailId"] + '" data-name="detailId"><i class="fa fa-pencil"></i> แก้ไข</button>'
                                                    //   : ""
                                                    //    )
                                                    + //(value5["isApprove"] == "N" ?
                                                    '<button type="button" class="btn btn-sm btn-default delete" data-pname="draftId" data-pid="' + value5["draftId"] + '" data-id="' + value6["detailId"] + '" data-name="detailId"><i class="fa fa-trash"></i> ลบ</button>'
                                                    //  : ""
                                                    //   )
                                                    + '</div>'
                                                    + '</td>'
                                                    + '</tr>';
                                            listArr["Detail"][value6["detailId"]] = value6;
                                            listArr["Draft"][value5["draftId"]]["Detail"][value6["detailId"]] = value6;
                                        });
                                    }

                                });
                            }
                        });
                    });

                });
                //   });
                //console.log(listArr["Draft"][5]["Detail"]);
                $("#tabMenu").html(menu);
                $("#tabContent").html(content);
                var contentAll = '';
                $.each(contentArr, function (key, value) {
                    contentAll += value
                    $("#table" + key + " tbody").html(value);
                    $("#table" + key).treetable({
                        expandable: true,
                        initialState: "expanded"
                    });
                });
                $("#tableall tbody").html(contentAll);
                $("#tableall").treetable({
                    expandable: true,
                    initialState: "expanded"
                });


                centerAction();
            });
        } else {

            $("#panelHome").html("<div class='text-center text-default col-sm-12'>ตัวชี้วัดคำรับรองการปฏิบัติงาน อนุมัติเรียบร้อยแล้ว</div>");
        }
    }

    function centerAction() {
        $("button.add").unbind().click(function () {
            var pId = $(this).attr("data-pid");
            var pName = $(this).attr("data-pname");
            var mId = $(this).attr("data-id");
            var mName = $(this).attr("data-name");
            var formName;
            if (mName == "strategyId") {
                formName = "Draft";
            } else {
                formName = "Detail";
            }
            // reset form for new insert

            $("#loadingForm").html('');
            $("#form" + formName).trigger('reset');
//            $("#form" + formName + " [data-lock=Y]").each(function () {
//                $(this).attr("disabled", false);
//            });
            $("#dialog" + formName).modal("show");
            //  listsKpi(pId);
            $("button.save" + formName).unbind().click(function () {
                var isValid = true;
                $('#form' + formName + ' input[required]').each(function () {
                    if ($(this).val() == "")
                        isValid = false;
                });
                if (isValid) {
                    var fdata = dataObject(mId, mName, pName);

                    //console.log(fdata);
                    draftInsert(fdata);

                } else {
                    alert("กรุณากรอกข้อมูลให้ครบ");
                }
            });
        });
        $("button.edit").unbind().click(function () {

            var pId = $(this).attr("data-pid");
            var pName = $(this).attr("data-pname");
            var mId = $(this).attr("data-id");
            var mName = $(this).attr("data-name");
            var formName;
            if (mName == "draftId") {
                formName = "Draft";
            } else {
                formName = "Detail";
            }
            //var edit = $(this).attr("data-edit");
            // reset form for new insert
            $("#loadingForm").html('');
            $("#form" + formName).trigger('reset');
            $("#dialog" + formName).modal("show");
            $("#form" + formName + " input[type=text],#form" + formName + " textarea,#form" + formName + " select").each(function () {
                var fid = $(this).attr("id");
                if (fid != "remark") {
                    $("#" + fid).val(listArr[formName][mId][fid]);
                } else {
                    $("#form" + formName + " #" + fid).val(listArr[formName][mId][fid]);
                }
            });
            $("button.save" + formName).unbind().click(function () {
                var isValid = true;
                $('#form' + formName + ' input[required]').each(function () {
                    if ($(this).val() == "")
                        isValid = false;
                });
                if (isValid) {
                    var fdata = dataObject(mId, mName, pName);

                    //console.log(fdata);
                    draftEdit(fdata);

                } else {
                    alert("กรุณากรอกข้อมูลให้ครบ");
                }
            });
        });
        $("button.delete").unbind("click").click(function () {
            var pId = $(this).attr("data-pid");
            var pName = $(this).attr("data-pname");
            var mId = $(this).attr("data-id");
            var mName = $(this).attr("data-name");
            var formName;
            if (mName == "draftId") {
                formName = "Draft";
            } else {
                formName = "Detail";
            }
            $("#dialogDelete" + formName).modal("show");
            $("#dialogDelete" + formName).find(".frmDel").each(function () {
                var fId = $(this).attr("id");
                $("#dialogDelete" + formName).find("#" + fId).html(getTag(listArr[formName][mId][fId]));

            });
            $("button.del" + formName).unbind("click").click(function () {
                var fdata = {};
                fdata[mName] = mId;
                fdata[pName] = pId;
               // console.log(fdata);
                draftDelete(fdata);
            });
        });
    }
    function findSeq(level, id) {
        var i = 1;
        var idName, seq = 0;
        idName = $("tr[data-tt-id=" + level + id + "]").attr("data-tt-parent-id");
        if (typeof idName !== "undefined") {
            while (i == 1) {
                var pName = $("tr[data-tt-id=" + idName + "]").attr("data-tt-parent-id");
                if (typeof pName == "undefined") {
                    seq = $("tr[data-tt-id=" + idName + "]").attr("data-seq");
                    i = 0;
                } else {
                    idName = pName;
                }
            }
        }
        //console.log(seq);
        return seq;
    }

    function draftInsert(fdata) {
        $("#loadingForm").html("Loading...");
        setTimeout(function () {
            var dataJSON = JSON.stringify({draft: fdata});
            var dataJSONEN = encodeURIComponent(dataJSON);
            var datas = callAjax("{{_context_path}}/api/actionplan/draft/insert", "post", dataJSONEN, "json");
            var data = datas["insert"];
            var type = datas["type"];

            if (typeof data !== "undefined" && data !== null) {
                if (data != false && type == "draft") {
                    $("#loadingForm").html('<span class="text-success">บันทึกข้อมูลเรียบร้อย</span>');
                    listArr["Draft"][data["draftId"]] = data;
                    listArr["Draft"][data["draftId"]]["Detail"] = {};
                    var input = "";
                    var node, node2;
                    input += '<tr data-tt-id="draft' + data["draftId"] + '" data-tt-parent-id="strategy' + data["strategyId"] + '" data-seq="' + data["projectSeq"] + '" >'
                            + '<td class="text-center"></td>'
                            + '<td>'
                            + '<span class="text-bold">' + data["projectSeq"] + ". " + data["projectName"] + '</span>'
                            + '</td>'
                            + '<td></td>'
                            + '<td class="text-center">' + (data["timeDuration"] ? data["timeDuration"] : "") + '</td>'
                            + '<td class="text-center">' + (data["budget"] ? data["budget"] : "") + '</td>'
                            + '<td class="text-center">' + (data["revenue"] ? data["revenue"] : "") + '</td>'
                            + '<td class="text-center">' + (data["other"] ? data["other"] : "") + '</td>'
                            + '<td class="text-center">' + (data["noBudget"] ? data["noBudget"] : "") + '</td>'
                            + '<td class="text-center">'
                            + '<button class="btn btn-sm btn-success add" data-id="' + data["draftId"] + '" data-name="draftId" data-pid="' + data["strategyId"] + '" data-pname="strategyId" ><i class="fa fa-plus-circle"></i> เพิ่ม</button>'
                            + '<button type="button" class="btn btn-sm btn-warning edit" data-edit="Y" data-id="' + data["draftId"] + '" data-name="draftId"><i class="fa fa-pencil"></i> แก้ไข</button>'
                            + '<button type="button" class="btn btn-sm btn-default delete" data-id="' + data["draftId"] + '" data-name="draftId" data-pid="' + data["strategyId"] + '" data-pname="strategyId"><i class="fa fa-trash"></i> ลบ</button>' + '</td>'
                            + '</tr>';
                    var seq = findSeq("strategy", data["strategyId"]);
                    node = $("#tableall").treetable("node", "strategy" + data["strategyId"]);
                    node2 = $("#table" + seq).treetable("node", "strategy" + data["strategyId"]);

                    $("#tableall").treetable("loadBranch", node, input);
                    $("#table" + seq).treetable("loadBranch", node2, input);
                    $("#tableall").treetable("sortBranch", node);
                    $("#table" + seq).treetable("sortBranch", node2);
                    $("#dialogDraft").modal("hide");
                    centerAction();
                }
                else if (data != false && type == "detail") {
                    $("#loadingForm").html('<span class="text-success">บันทึกข้อมูลเรียบร้อย</span>');
                    listArr["Detail"][data["detailId"]] = data;
                    listArr["Draft"][data["draftId"]]["Detail"][data["detailId"]] = data;
                    var input = "";
                    var node, node2;
                    input += '<tr data-tt-id="detail' + data["detailId"] + '" data-tt-parent-id="draft' + data["draftId"] + '"  data-seq="' + data["detailSeq"] + '">'
                            + '<td class="text-center"></td>'
                            + (data["isActive"] == "Y" ? '<td>' : '<td class="text-primary">') + '- ' + text2html(data["detailName"]) + '</td>'
                            + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + data["unit"] + '</td>'
                            + '<td class="text-center"></td>'
                            + '<td class="text-center"></td>'
                            + '<td class="text-center"></td>'
                            + '<td class="text-center"></td>'
                            + '<td class="text-center"></td>'
                            + '<td>'
                            + '<div class="btn-group">'
                            + //(data["isApprove"] == "N" ?
                            '<button type="button" class="btn btn-sm btn-warning edit" data-edit="Y" data-name="detailId" data-id="' + data["detailId"] + '"><i class="fa fa-pencil"></i> แก้ไข</button>'
                            //   : ""
                            //    )
                            + //(data["isApprove"] == "N" ?
                            '<button type="button" class="btn btn-sm btn-default delete" data-name="detailId" data-id="' + data["detailId"] + '" data-pid="' + data["draftId"] + '" data-pname="draftId" ><i class="fa fa-trash"></i> ลบ</button>'
                            //  : ""
                            //   )
                            + '</div>'
                            + '</td>'
                            + '</tr>';
                    var seq = findSeq("draft", data["draftId"]);
                    node = $("#tableall").treetable("node", "draft" + data["draftId"]);
                    node2 = $("#table" + seq).treetable("node", "draft" + data["draftId"]);

                    $("#tableall").treetable("loadBranch", node, input);
                    $("#table" + seq).treetable("loadBranch", node2, input);
                    $("#tableall").treetable("sortBranch", node);
                    $("#table" + seq).treetable("sortBranch", node2);
                    $("#dialogDetail").modal("hide");
                    centerAction();
                }
                else {
                    $("#loadingForm").html('<span class="text-danger">ไม่สามารถบันทึกข้อมูลได้</span>');
                }
            }
        }
        , 500);
    }

    function draftEdit(fdata) {
        $("#loadingForm").html("Loading...");
        setTimeout(function () {
            var dataJSON = JSON.stringify({draft: fdata});
            var dataJSONEN = encodeURIComponent(dataJSON);
            var datas = callAjax("{{_context_path}}/api/actionplan/draft/update", "post", dataJSONEN, "json");
            var data = datas["update"];
            var type = datas["type"];

            if (typeof data !== "undefined" && data !== null) {
                if (data != false && type == "draft") {
                    $("#loadingForm").html('<span class="text-success">บันทึกข้อมูลเรียบร้อย</span>');
                    var tempDetail = listArr["Draft"][data["draftId"]]["Detail"];
                    listArr["Draft"][data["draftId"]] = data;
                    listArr["Draft"][data["draftId"]]["Detail"] = tempDetail;
                    var input = "";
                    var node, node2;
                    input += '<tr data-tt-id="draft' + data["draftId"] + '" data-tt-parent-id="strategy' + data["strategyId"] + '" data-seq="' + data["projectSeq"] + '" >'
                            + '<td class="text-center"></td>'
                            + '<td>'
                            + '<span class="text-bold">' + data["projectSeq"] + ". " + data["projectName"] + '</span>'
                            + '</td>'
                            + '<td></td>'
                            + '<td class="text-center">' + (data["timeDuration"] ? data["timeDuration"] : "") + '</td>'
                            + '<td class="text-center">' + (data["budget"] ? data["budget"] : "") + '</td>'
                            + '<td class="text-center">' + (data["revenue"] ? data["revenue"] : "") + '</td>'
                            + '<td class="text-center">' + (data["other"] ? data["other"] : "") + '</td>'
                            + '<td class="text-center">' + (data["noBudget"] ? data["noBudget"] : "") + '</td>'
                            + '<td class="text-center">'
                            + '<button class="btn btn-sm btn-success add" data-id="' + data["draftId"] + '" data-name="draftId" data-pid="' + data["strategyId"] + '" data-pname="strategyId" ><i class="fa fa-plus-circle"></i> เพิ่ม</button>'
                            + '<button type="button" class="btn btn-sm btn-warning edit" data-edit="Y" data-id="' + data["draftId"] + '" data-name="draftId"><i class="fa fa-pencil"></i> แก้ไข</button>'
                            + '<button type="button" class="btn btn-sm btn-default delete" data-id="' + data["draftId"] + '" data-name="draftId" ><i class="fa fa-trash"></i> ลบ</button>' + '</td>'
                            + '</tr>';
                    var seq = findSeq("strategy", data["strategyId"]);
                    $.each(tempDetail, function (k, v) {
                        input += '<tr data-tt-id="detail' + v["detailId"] + '" data-tt-parent-id="draft' + v["draftId"] + '"  data-seq="' + v["detailSeq"] + '">'
                                + '<td class="text-center"></td>'
                                + (v["isActive"] == "Y" ? '<td>' : '<td class="text-primary">') + '- ' + text2html(v["detailName"]) + '</td>'
                                + (v["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + v["unit"] + '</td>'
                                + '<td class="text-center"></td>'
                                + '<td class="text-center"></td>'
                                + '<td class="text-center"></td>'
                                + '<td class="text-center"></td>'
                                + '<td class="text-center"></td>'
                                + '<td>'
                                + '<div class="btn-group">'
                                + //(data["isApprove"] == "N" ?
                                '<button type="button" class="btn btn-sm btn-warning edit" data-edit="Y" data-name="detailId" data-id="' + v["detailId"] + '"><i class="fa fa-pencil"></i> แก้ไข</button>'
                                //   : ""
                                //    )
                                + //(data["isApprove"] == "N" ?
                                '<button type="button" class="btn btn-sm btn-default delete" data-name="detailId" data-id="' + v["detailId"] + '"><i class="fa fa-trash"></i> ลบ</button>'
                                //  : ""
                                //   )
                                + '</div>'
                                + '</td>'
                                + '</tr>';
                    });
                    node = $("#tableall").treetable("node", "strategy" + data["strategyId"]);
                    node2 = $("#table" + seq).treetable("node", "strategy" + data["strategyId"]);
                    $("#tableall").treetable("removeNode", "draft" + data["draftId"]);
                    $("#table" + seq).treetable("removeNode", "draft" + data["draftId"]);
                    $("#tableall").treetable("loadBranch", node, input);
                    $("#table" + seq).treetable("loadBranch", node2, input);
                    $("#tableall").treetable("sortBranch", node);
                    $("#table" + seq).treetable("sortBranch", node2);
                    $("#dialogDraft").modal("hide");
                    centerAction();
                }
                else if (data != false && type == "detail") {
                    $("#loadingForm").html('<span class="text-success">บันทึกข้อมูลเรียบร้อย</span>');
                    listArr["Detail"][data["detailId"]] = data;
                    listArr["Draft"][data["draftId"]]["Detail"][data["detailId"]] = data;
                    var input = "";
                    var node, node2;
                    input += '<tr data-tt-id="detail' + data["detailId"] + '" data-tt-parent-id="draft' + data["draftId"] + '"  data-seq="' + data["detailSeq"] + '">'
                            + '<td class="text-center"></td>'
                            + (data["isActive"] == "Y" ? '<td>' : '<td class="text-primary">') + '- ' + text2html(data["detailName"]) + '</td>'
                            + (data["isActive"] == "Y" ? '<td class="center">' : '<td class="text-primary center">') + data["unit"] + '</td>'
                            + '<td class="text-center"></td>'
                            + '<td class="text-center"></td>'
                            + '<td class="text-center"></td>'
                            + '<td class="text-center"></td>'
                            + '<td class="text-center"></td>'
                            + '<td>'
                            + '<div class="btn-group">'
                            + //(data["isApprove"] == "N" ?
                            '<button type="button" class="btn btn-sm btn-warning edit" data-edit="Y" data-name="detailId" data-id="' + data["detailId"] + '"><i class="fa fa-pencil"></i> แก้ไข</button>'
                            //   : ""
                            //    )
                            + //(data["isApprove"] == "N" ?
                            '<button type="button" class="btn btn-sm btn-default delete" data-name="detailId" data-id="' + data["detailId"] + '"><i class="fa fa-trash"></i> ลบ</button>'
                            //  : ""
                            //   )
                            + '</div>'
                            + '</td>'
                            + '</tr>';
                    var seq = findSeq("draft", data["draftId"]);
                    node = $("#tableall").treetable("node", "draft" + data["draftId"]);
                    node2 = $("#table" + seq).treetable("node", "draft" + data["draftId"]);

                    $("#tableall").treetable("removeNode", "detail" + data["detailId"]);
                    $("#table" + seq).treetable("removeNode", "detail" + data["detailId"]);
                    $("#tableall").treetable("loadBranch", node, input);
                    $("#table" + seq).treetable("loadBranch", node2, input);
                    $("#tableall").treetable("sortBranch", node);
                    $("#table" + seq).treetable("sortBranch", node2);
                    $("#dialogDetail").modal("hide");
                    centerAction();
                }
                else {
                    $("#loadingForm").html('<span class="text-danger">ไม่สามารถบันทึกข้อมูลได้</span>');
                }
            }
        }
        , 500);
    }

    function draftDelete(fdata) {
        var dataJSON = JSON.stringify({draft: fdata});
        var dataJSONEN = encodeURIComponent(dataJSON);
        var datas = callAjax("{{_context_path}}/api/actionplan/draft/delete", "post", dataJSONEN, "json");
        var data = datas["delete"];
        var type = datas["type"];
        if (typeof datas !== "undefined" && datas !== null) {
            var seq = findSeq("draft", data["draftId"]);
            $("#tableall").treetable("removeNode", type + data[type + "Id"]);
            $("#table" + seq).treetable("removeNode", type + data[type + "Id"]);

            if (type == "draft") {
                $.each(listArr["Draft"][fdata["draftId"]]["Detail"], function (k, v) {
                    listArr["Detail"][k] = [];
                });
                listArr["Draft"][fdata["draftId"]] = [];
                $("#dialogDeleteDraft").modal("hide");
            } else if (type == "detail") {
                listArr["Draft"][fdata["draftId"]]["Detail"][fdata["detailId"]] = [];
                listArr["Detail"][fdata["detailId"]] = [];
                $("#dialogDeleteDetail").modal("hide");
            }
        }
    }

    function dataObject(mId, mName, pName) {
//        console.log("mId " + mId);
//        console.log("mName " + mName);
//        console.log("pName " + pName);
        var fParam = {};
        fParam[mName] = mId;
        var formName;
        // console.log(pName);
        if ((mName == "strategyId" && typeof pName === "undefined") || (mName == "draftId" && typeof pName === "undefined")) {
            formName = "formDraft";
            fParam["departmentId"] = deptId;
            fParam["typeId"] = typeId;
            fParam["periodCode"] = periodCode;
            //   console.log("draft");
        } else if ((mName == "draftId" && pName == "strategyId") || (mName == "detailId")) {
            formName = "formDetail";
            // console.log("detail");
        }
        $("#" + formName + " select, #" + formName + " input[type=text], #" + formName + " textarea").each(function () {
            var name = $(this).attr("name");
            var val = $(this).val();
            fParam[name] = val;
        });
        var fdata = {};
        fdata = fParam;
        return fdata;
    }
</script>